# AIによる総合得点 機能実装ロードマップ

## 1. 概要

睡眠分析レポート画面に、AIが睡眠データ全体を分析して算出する「総合得点」を100点満点で表示する機能を実装する。得点はドーナツグラフを用いて視覚的に表現する。

## 2. 実装フェーズ

### フェーズ1: AIサービス（バックエンド）の改修

このフェーズでは、AIからのレスポンスに総合得点を含めるための変更を行う。

- **タスク1.1: AIへの指示（プロンプト）の更新**
  - **対象ファイル:** `lib/services/analysis_service.dart`
  - **目的:** Gemini APIに送信するプロンプトを更新し、既存の分析項目に加えて「0〜100点満点の総合得点」を算出するように依頼する。
  - **詳細:**
    - 睡眠データ全体を俯瞰し、睡眠の質、規則性、長さなどを総合的に評価して点数化するよう指示を追加する。
    - ユーザーの入力スコアの単純平均ではなく、AI独自のアルゴリズムで評価するよう明記する。

- **タスク1.2: AIの応答JSON形式の更新**
  - **対象ファイル:** `lib/services/analysis_service.dart`
  - **目的:** プロンプト内でAIに期待するJSON出力形式の例を更新し、新しい`overall_score`フィールドを追加する。
  - **変更後JSON形式（例）:**
    ```json
    {
      "overall_score": 85,
      "overall_comment": "ここに総評を記述",
      "positive_points": [ ... ],
      "improvement_suggestions": [ ... ]
    }
    ```

- **タスク1.3: キャッシュモデルの更新**
  - **対象ファイル:** `lib/models/analysis_cache.dart`
  - **目的:** AIからの新しい応答をキャッシュに正しく保存・読込できるよう、キャッシュデータモデルを更新する。
  - **詳細:**
    - `AnalysisCache`クラスに`overallScore`プロパティ（`int`型）を追加する。
    - `fromMap`, `toMap`, `copyWith`などの関連メソッドを更新し、新しいプロパティを処理できるようにする。

### フェーズ2: UI（フロントエンド）の実装

このフェーズでは、AIから受け取った総合得点を画面に表示するためのUIコンポーネントを実装する。

- **タスク2.1: ドーナツグラフウィジェットの作成**
  - **対象ファイル:** `lib/screens/analysis_report_screen.dart`
  - **目的:** 点数を視覚的に表現するための、再利用可能なドーナツグラフウィジェットを新規作成する。
  - **詳細:**
    - `CustomPainter`を利用して、背景の円とスコアを表す前景の円弧を描画する。
    - 中央にスコアの数値を表示する`Text`ウィジェットを配置する。
    - グラフの色やアニメーション効果もこのウィジェット内で管理する。

- **タスク2.2: 総合得点表示カードの作成**
  - **対象ファイル:** `lib/screens/analysis_report_screen.dart`
  - **目的:** 「AIによる総合得点」セクション全体を構成する新しいカードウィジェットを作成する。
  - **詳細:**
    - `_buildOverallScoreCard`のようなプライベートメソッドとして実装する。
    - カードには、タイトル（「AIによる総合得点」）、タスク2.1で作成したドーナツグラフ、およびグラフ中央に表示される得点が含まれる。

- **タスク2.3: 画面レイアウトへの統合**
  - **対象ファイル:** `lib/screens/analysis_report_screen.dart`
  - **目的:** 作成した総合得点表示カードを分析レポート画面の適切な位置に配置する。
  - **詳細:**
    - `build`メソッド内の`ListView`の先頭、「AIによる総評」カードの上に追加する。

- **タスク2.4: データ連携処理**
  - **対象ファイル:** `lib/screens/analysis_report_screen.dart`
  - **目的:** AIサービスから受け取った`overall_score`を新しく作成したUIコンポーネントに渡す。
  - **詳細:**
    - `_triggerAnalysisCheck`メソッド内で`_llmAnalysisResult`マップから`overall_score`を取得する。
    - 取得したスコアを`_buildOverallScoreCard`ウィジェットに引数として渡し、画面に描画させる。

### フェーズ3: テストと調整

- **タスク3.1: 動作確認**
  - **目的:** 機能全体が意図通りに動作することを端から端まで確認する。
  - **詳細:**
    - アプリのキャッシュをクリアした後、分析レポート画面を開く。
    - APIから取得したスコアが正しく表示され、ドーナツグラフが適切に描画されることを確認する。

- **タスク3.2: UI/UXの微調整**
  - **目的:** 新しいUIがアプリ全体のデザインと調和し、視覚的に魅力的であることを確認する。
  - **詳細:**
    - レイアウト、マージン、色、フォントサイズなどを確認し、必要に応じて調整する。

- **タスク3.3: エッジケースの考慮**
  - **目的:** 想定外の状況でもアプリがクラッシュしないように、堅牢性を高める。
  - **詳細:**
    - AIが何らかの理由で`overall_score`を返さなかった場合に、UIがどう振る舞うかを確認する。（例: セクション自体を非表示にする、エラーメッセージを表示するなど）
    - 0点や100点の場合の表示が崩れないか確認する。

## 4. 変更履歴

- **2025-10-16:**
  - ドキュメント作成: Gemini-Pro