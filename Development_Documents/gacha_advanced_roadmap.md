# Zzzone ガチャ機能 高度化ロードマップ

## 1. 概要

`gacha_specification.md`に基づき、既存のガチャ機能に、より高度な機能を追加実装する。主な実装項目は「レアリティと排出確率」「ガチャ履歴」「複数回ガチャ」であった。

### 1.1. 設計方針
- **JSON駆動:** 機能の拡張は、主に`gacha_config.json`と`gacha_items.json`の更新によって行い、コードへの影響を最小限に抑える。
- **データ永続化:** ユーザーのガチャ履歴は、睡眠記録と同様にローカルデータベース(SQLite)に保存する。
- **UI/UX:** 既存のUIに新機能を自然に統合し、リッチなユーザー体験を提供する。

---

## 2. 詳細実装計画（完了済み）

### フェーズ1: レアリティシステムの導入
**目的:** すべての景品が均等に排出される現在の仕様から、レアリティに基づいた確率的な排出ロジックに変更する。

### フェーズ2: ガチャ履歴機能の実装
**目的:** ユーザーが過去に引いたガチャの結果をすべて閲覧できる機能を追加する。

### フェーズ3: 複数回ガチャ（10連）の実装
**目的:** 一度に複数回ガチャを引き、結果を一覧できる、いわゆる「10連ガチャ」機能を実装する。

---

## 4. 実行ログ

### 2025-10-05 (Part 2)

- **フェーズ4: ガチャ演出アニメーションの実装**
  - **状態:** 進行中...
  - **Task 4.1 (UI):** `lib/gacha/screens/gacha_result_screen.dart` を新規作成。単発ガチャの結果表示専用画面を実装。✅
      - **Task 4.2 (UI):** `lib/gacha/screens/gacha_animation_screen.dart` を新規作成し、シンプルな演出アニメーション画面を実装。✅
      - **Task 4.3 (Logic):** `gacha_screen.dart`の1回ガチャ実行ロジックを、ダイアログ表示からアニメーション画面への遷移に変更。✅
  - **状態:** 完了 ✅

### フェーズ4: ガチャ演出アニメーションの実装

**目的:** 単発ガチャを引いた際に、シンプルなダイアログの代わりに、専用のアニメーション画面と結果画面を表示し、ユーザー体験を向上させる。

- [ ] **Task 4.1 (UI):** `lib/gacha/screens/gacha_result_screen.dart` を新規作成する。
  - **詳細:** 1回ガチャの最終結果（獲得した名言とレアリティ）を大きく表示するための専用画面。仕様書ベースで作成する。

- [ ] **Task 4.2 (UI):** `lib/gacha/screens/gacha_animation_screen.dart` を新規作成する。
  - **詳細:** ガチャを引いてから結果が表示されるまでの、シンプルな待機アニメーションを表示する画面。仕様書ベースで作成する。

- [ ] **Task 4.3 (Logic):** `gacha_screen.dart` の `_pullGacha` メソッドを修正する。
  - **詳細:** 1回ガチャ実行後、`_showResultDialog` を呼び出す代わりに、新しい `GachaAnimationScreen` に遷移するようにロジックを変更する。

---

## 4. 実行ログ

### 2025-10-05

- **フェーズ1: レアリティシステムの導入**
  - **状態:** 完了 ✅
  - **Task 1.1:** `gacha_config.json` を更新し、3段階のレアリティ（コモン、レア、激レア）と排出確率を定義。✅
  - **Task 1.2:** `gacha_items.json` の全名言に、設定した確率分布に沿ってレアリティを再割り当て。✅
  - **Task 1.3:** モデルクラス(`gacha_rarity.dart`, `gacha_item.dart`)を拡張し、新しいJSONの構造に対応。✅
  - **Task 1.4:** `gacha_screen.dart`の抽選ロジックを、設定された確率に基づく重み付き抽選に変更。✅
  - **Task 1.5:** `gacha_screen.dart`の結果表示ダイアログを、レアリティ名と色が表示されるように修正。✅

- **フェーズ2: ガチャ履歴機能の実装**
  - **状態:** 完了 ✅
  - **Task 2.1 (DB):** `DatabaseHelper`を修正し、ガチャ履歴を保存する`gacha_pull_history`テーブルと関連メソッドを追加。✅
  - **Task 2.2 (App Logic):** `gacha_screen.dart`のガチャ実行ロジックを修正し、すべてのガチャ結果をローカルDBの履歴テーブルに保存するように変更。✅
  - **Task 2.3 (UI):** `lib/gacha/screens/gacha_history_screen.dart` を新規作成し、ガチャの全履歴をリスト表示する画面を実装。✅
  - **Task 2.4 (UI):** `shop_screen.dart`に、ガチャ履歴画面へ遷移するためのボタンを設置。✅

- **フェーズ3: 複数回ガチャ（10連）の実装**
  - **状態:** 完了 ✅
  - **Task 3.1:** `gacha_config.json`を更新し、10連ガチャのコストと排出個数を定義。✅
  - **Task 3.2:** `gacha_config.dart`モデルを拡張し、10連ガチャの設定値を読み込めるように修正。✅
  - **Task 3.3 (UI):** `gacha_screen.dart`に「10回引く」ボタンを追加。✅
  - **Task 3.4 (App Logic):** 「10回引く」ボタンのロジックを実装。10回分の抽選、コイン消費、履歴保存をまとめて実行するように変更。✅
  - **Task 3.5 (UI):** `multi_gacha_result_screen.dart`を新規作成し、10連ガチャの結果をグリッド表示する画面を実装。また、ガチャ実行後にこの画面へ遷移するように修正。✅