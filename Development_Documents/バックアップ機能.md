# Zzzone - Dropboxバックアップ機能 実装ロードマップ

## 概要

ローカルデータ（SQLite、shared_preferences）をユーザー自身のDropboxアカウントに退避・復元する機能を実装するためのロードマップです。
このロードマップは、別の開発環境で作成されました。そのため、適宜自身の開発環境に合わせて調整してください。

-   **バックアップ対象:** SQLiteデータベース（睡眠記録、獲得した名言リスト、ガチャ履歴、お知らせの未読状態）、および `shared_preferences`（各種設定）。
-   **対象外（サーバー管理）:** スリープコイン、ランキング情報、ギフトコード関連。（これらはSupabase側で管理されているため）

---

## フェーズ1: 認証基盤の構築 (OAuth 2.0連携)

Dropbox APIを利用するための認証フローを確立します。

### タスク1.1: Dropbox Appの登録

-   Dropbox App Consoleで「Zzzone」用のアプリを作成します。
-   **Permissions (権限):** `files.content.write` (書き込み), `files.content.read` (読み取り) を設定します (Scoped Access推奨)。
-   **App Key (Client ID)** と **App Secret (Client Secret)** を取得します。

### タスク1.2: 環境変数の設定

-   取得したApp Key/Secretを、現在の仕様（`README.md`）に従い、`.env` (デバッグモード) とコンパイル時環境変数 (リリースモード) に安全に格納します。

### タスク1.3: 認証UIの作成

-   「設定」画面などに「Dropboxと連携する」ボタンを配置します。
-   連携済みの場合、「Dropboxとの連携を解除する」ボタンと、連携中のアカウント情報（メールアドレスなど）を表示するUIに変更します。

### タスク1.4: OAuth 2.0 認証フローの実装

-   「連携」ボタン押下時、`flutter_web_auth` や `url_launcher` を使用してDropboxの認証画面をブラウザ（またはWebView）で開きます。
-   ユーザーが許可すると、アプリはリダイレクトURI経由で「認可コード」を受け取ります。
-   受け取った認可コードを使い、既存の `http` パッケージでDropboxのトークンエンドポイントを叩き、「アクセストークン」と「リフレッシュトークン」を取得します。

### タスク1.5: トークンの安全な保存

-   取得したアクセストークンとリフレッシュトークンは、`shared_preferences` ではなく、より安全な `flutter_secure_storage` などのKeychain/Keystoreラッパーに保存します。

### タスク1.6: 連携解除機能の実装

-   「連携解除」ボタン押下時、`flutter_secure_storage` からトークンを削除します。
-   同時に、Dropbox APIの `token/revoke` エンドポイントを叩き、サーバー側でもトークンを無効化します。

---

## フェーズ2: バックアップ (アップロード) 機能の実装

ローカルデータをDropboxにアップロードする機能を実装します。

### タスク2.1: バックアップUIの作成

-   「設定 > バックアップ」画面に「今すぐバックアップ」ボタンを配置します。
-   「最終バックアップ日時」を表示するラベルを配置します（日時は `shared_preferences` に保存）。

### タスク2.2: バックアップ対象ファイルの特定

-   `sqflite` の `getDatabasesPath()` を使用し、SQLiteデータベースファイル（`.db`ファイル）のフルパスを取得します。
-   `path_provider` を使用し、`shared_preferences` の実体ファイル（XMLやJSON）のパスを取得します。

### タスク2.3: (推奨) データのアーカイブ

-   バックアップの整合性を保ち、APIリクエストを1回で済ませるため、タスク2.2で特定したファイル群を `archive` パッケージなどを用いて単一のファイル（例: `zzzone_backup.zip`）に圧縮・アーカイブします。

### タスク2.4: Dropbox API (Upload) の実装

-   保存されたアクセストークンをHTTPヘッダーに付与します。
-   `http` (またはファイル送信に強い `dio`) を使用し、Dropbox APIの `files/upload` エンドポイントに、アーカイブしたファイル（`zzzone_backup.zip`）をPOSTします。
-   アップロード先は、アプリ専用フォルダ内の固定パス（例: `/zzzone_backup.zip`）にします。

### タスク2.5: 状態管理とフィードバック

-   アップロード中はローディングインジケーターを表示します。
-   **成功時:** `shared_preferences` に現在の時刻を「最終バックアップ日時」として保存し、UIに反映させます。「バックアップが完了しました」というトースト/スナックバーを表示します。
-   **失敗時:** エラーメッセージ（認証切れ、ネットワークエラーなど）を表示します。

---

## フェーズ3: リストア (復元) 機能の実装

Dropbox上のバックアップデータをローカルに書き戻す機能を実装します。

### タスク3.1: リストアUIの作成

-   「設定 > バックアップ」画面に「データを復元する」ボタンを配置します。
-   **最重要:** ボタン押下時、「現在のデータはすべて上書きされます。よろしいですか？」という確認ダイアログ（AlertDialog）を表示し、誤操作を防ぎます。

### タスク3.2: Dropbox API (Download) の実装

-   アクセストークンを使用し、`files/download` エンドポイントからバックアップファイル（`/zzzone_backup.zip`）をアプリの一時ディレクトリにダウンロードします。

### タスク3.3: データベースのクローズ

-   **重要:** ファイルを上書きする前に、現在開いているSQLiteデータベースのインスタンスを必ず `database.close()` して、ファイルロックを解除します。

### タスク3.4: データの展開と上書き

-   ダウンロードしたアーカイブファイル（`.zip`）を一時ディレクトリで展開します。
-   展開したデータベースファイル（`.db`）と設定ファイル（XMLなど）を、`getDatabasesPath()` や `path_provider` で取得した正規のパスに強制的に上書き（移動またはコピー）します。

### タスク3.5: アプリの再起動

-   復元が完了したら、「データの復元が完了しました。アプリを再起動します」と表示し、アプリをプログラム的に再起動（またはユーザーに再起動を強く促す）して、新しいデータを読み込ませます。

---

## フェーズ4: テストと仕上げ

### タスク4.1: 機能テスト

-   認証連携、解除が正常に行えるか。
-   バックアップを実行し、Dropbox上にファイルが生成されるか。
-   一度アプリをアンインストール（またはデータをクリア）した後、リストアを実行し、睡眠記録、名言リスト、各種設定 が復元されるか。

### タスク4.2: エラーケースのテスト

-   ネットワーク接続がない状態でのバックアップ/リストア。
-   バックアップファイルがDropboxに存在しない場合のリストア。
-   アクセストークンが（手動でRevokeするなどして）無効になった場合の処理。

### タスク4.3: ドキュメント更新

-   `README.md` に「バックアップ機能」のセクションを追加します。

### 変更履歴を適宜下部に追記