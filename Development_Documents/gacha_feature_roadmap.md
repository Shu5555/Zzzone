# Zzzone ガチャ機能 実装ロードマップ

## 1. 概要

`gacha_specification.md` および `ガチャ機能.txt` の要求に基づき、スリープコインを使用して「名言」を獲得できるガチャ機能を実装する。

### 1.1. 設計方針
- **データ永続化:** 当初はSupabaseを検討したが、ユーザーの要望により、獲得した名言は睡眠記録と同様にローカルデータベース(SQLite / SharedPreferences)で管理する。
- **疎結合:** `lib/gacha` モジュールとして機能をまとめ、既存コードへの影響を最小限に留める。
- **UI/UX:** 既存の画面（ショップ、プロフィール、ホーム）に新機能を自然に統合する。

### 1.2. 仮仕様

- **ガチャコスト:** 1回 **100** スリープコイン
- **排出確率:** 全ての名言は均等な確率で排出。
- **重複:** 名言の重複排出を許容し、重複時の特別な補填は行わない。

---

## 2. 詳細実装計画

### フェーズ0: プロジェクトのセットアップ
- **状態:** 完了 ✅

### フェーズ1: データ定義とバックエンド対応 → ローカルDB対応
- **状態:** 完了 ✅

### フェーズ2: アプリケーションロジックの実装
- **状態:** 完了 ✅

### フェーズ3: UIの実装と改修
- **状態:** 完了 ✅

---

## 3. 実行ログ

### 2025-10-05

- **フェーズ0: プロジェクトのセットアップ**
  - **状態:** 完了 ✅
  - **詳細:** `変更履歴.md`の作成、`lib/gacha`および`assets/gacha`ディレクトリの作成、`pubspec.yaml`へのアセットパスの追加を完了。

- **フェーズ1: データ定義とバックエンド/ローカルDB対応**
  - **状態:** 完了 ✅
  - **詳細:** ガチャの景品(`gacha_items.json`)と設定(`gacha_config.json`)のJSONファイルを作成。当初のSupabase案からローカルDB案へのアーキテクチャ変更を実施。`DatabaseHelper`を拡張し、`unlocked_quotes`テーブルと関連メソッドを追加。SupabaseのRPCをコイン消費のみの`deduct_coins_for_gacha`に置き換え。

- **フェーズ2: アプリケーションロジックの実装**
  - **状態:** 完了 ✅
  - **詳細:** `gacha/models`配下にデータモデルクラスを作成し、`gacha/services`にデータローダーを作成。`SupabaseRankingService`と`DatabaseHelper`を連携させる形で、ガチャ機能に必要なロジックを実装。

- **フェーズ3: UIの実装と改修**
  - **状態:** 完了 ✅
  - **詳細:** `GachaScreen`, `QuoteListScreen`を新設し、`ShopScreen`, `ProfileScreen`, `HomeScreen`に必要なUIの追加とロジックの修正を完了。

- **お気に入り/ランダムモード切替機能の実装**
  - **状態:** 完了 ✅
  - **詳細:** 名言一覧画面に、お気に入り固定と日替わりランダム表示を切り替えるトグル機能を実装。ホーム画面の表示ロジックも対応。

- **バグ修正**
  - **状態:** 完了 ✅
  - **詳細:** 複数の実装段階で発生したビルドエラー、実行時エラー（ランダムモード解除不可、外部キー制約違反、ローカルDBチェックの不具合など）をすべて修正。

- **データ統合**
  - **状態:** 完了 ✅
  - **詳細:** 古い`quotes.json`のデータを新しい`gacha_items.json`に統合し、不要になった古いファイルを削除。それに伴う`pubspec.yaml`の修正も完了。
