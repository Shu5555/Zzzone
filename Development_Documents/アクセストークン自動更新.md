# Dropbox - アクセストークン自動更新（Refresh Token）機能 実装ロードマップ

## 概要
`expired_access_token` エラー（アクセストークンの有効期限切れ）を検知した際、ユーザーに再認証を強いることなく、アプリが内部的に新しいアクセストークンを再取得する仕組みを実装します。

これは、既存のDropboxバックアップ機能（フェーズ1〜4）に対する「改修」ロードマップです。
このロードマップは、別の開発環境で作成されました。適宜自身の環境に合わせて調整してください。

---

## フェーズA: 認証（フェーズ1）の改修 - リフレッシュトークンの取得と保存

既存の認証フロー（ロードマップ フェーズ1）に、リフレッシュトークンの処理を追加します。

### タスクA.1: 認証リクエストの変更 (PKCEフロー)
* **現状:** `response_type=code` または `response_type=token` (Implicit Grant) で認証している可能性があります。
* **変更:** Dropboxが推奨する「**PKCE (Proof Key for Code Exchange)**」フローに移行します。これは、`App Secret` を必要とせず、リフレッシュトークンを安全に取得できる、Zzzoneのようなモバイルアプリに最適な認証方式です。
* **実装:**
    1.  `code_verifier` (ランダムな文字列) と `code_challenge` (VerifierをSHA256ハッシュ化したもの) をクライアント側で生成します。
    2.  認証URL (`/oauth2/authorize`) に `code_challenge` と `code_challenge_method=S256` をパラメータとして追加します。

### タスクA.2: トークン取得リクエストの変更
* **現状:** 認可コード (`code`) をアクセストークンに交換 (タスク1.4)。
* **変更:** `/oauth2/token` エンドポイントへのリクエスト時に、`code` に加えて、タスクA.1で生成した `code_verifier` と `grant_type=authorization_code` をPOSTデータに含めます。
* **結果:** Dropboxからのレスポンスに `access_token` と共に `refresh_token` が含まれるようになります。

### タスクA.3: リフレッシュトークンの安全な保存
* **現状:** `access_token` を `flutter_secure_storage` に保存 (タスク1.5)。
* **変更:** 取得した `refresh_token` も、`access_token` とは別のキーで `flutter_secure_storage` に安全に保存します。
    * 例: `dropbox_access_token` と `dropbox_refresh_token`

---

## フェーズB: APIクライアント（ラッパー）の構築

Dropbox APIへのリクエストを共通化し、トークン更新処理を一元管理するクラスを作成します。

### タスクB.1: HTTPクライアントのラッパー作成
* `http` パッケージを直接呼ぶのではなく、専用の `DropboxApiClient` クラスを作成します。
* このクラスは、`upload()` や `download()` などのメソッドを持ちます。
* 各メソッドは、内部で `flutter_secure_storage` から `access_token` を読み出し、HTTPヘッダーの `Authorization: Bearer <token>` に設定してリクエストを送信します。

### タスクB.2: トークン更新ロジックの実装
* `DropboxApiClient` 内に、プライベートな `_refreshToken()` メソッドを実装します。
* **処理内容:**
    1.  `flutter_secure_storage` から `refresh_token` を読み出します。
    2.  Dropboxの `/oauth2/token` エンドポイントに対し、`grant_type=refresh_token`, `refresh_token=<token>`, `client_id=YOUR_APP_KEY` をPOSTします。
    3.  レスポンスとして新しい `access_token` を受け取ります。 (※Dropboxの場合、`refresh_token` は使い捨てではない可能性が高いですが、もし新しい `refresh_token` が返ってきたらそれも更新します)
    4.  新しい `access_token` を `flutter_secure_storage` に上書き保存します。
    5.  成功/失敗を呼び出し元に返します。

---

## フェーズC: API呼び出し処理の改修 - 自動再試行

バックアップ（フェーズ2）やリストア（フェーズ3）など、実際のAPI呼び出し部分を改修します。

### タスクC.1: エラーハンドリングと自動再試行
* `DropboxApiClient` の `upload()` や `download()` メソッド（タスクB.1）内に、エラーハンドリングを実装します。
* **処理フロー:**
    1.  `http` でAPIリクエストを実行 (例: `files/upload`)。
    2.  `try-catch` ブロックでレスポンス（または`http.Response`のステータスコードとBody）を監視します。
    3.  **もし** レスポンスが失敗し、そのエラー内容が `expired_access_token` だった場合（画像のエラーメッセージを参考に判定）:
        a. `_refreshToken()` (タスクB.2) を呼び出してトークンを更新します。
        b. **もし** トークン更新に成功したら、`files/upload` リクエストを**もう一度だけ自動で再試行**します。
        c. **もし** トークン更新自体に失敗した（例: リフレッシュトークンも無効）場合は、ユーザーに再認証を促すエラー（例: 「再ログインが必要です」）を返します。
    4.  `expired_access_token` 以外のエラー（例: ネットワークエラー、ファイルなし）の場合は、そのままエラーを返します。

### タスクC.2: 既存機能の呼び出し修正
* 「今すぐバックアップ」ボタン（タスク2.4）や「データを復元」（タスク3.2）の処理を、`http` の直接呼び出しから `DropboxApiClient.upload()` / `DropboxApiClient.download()` の呼び出しに差し替えます。

---

## フェーズD: テスト

### タスクD.1: 正常系テスト
* トークン更新ロジックを実装した後、バックアップ/リストアが正常に行えることを確認します。

### タスクD.2: 異常系テスト（トークン失効）
* **テスト方法:**
    1.  一度Dropbox連携を完了させます。
    2.  トークンの有効期限が切れるまで（通常は数時間）待機します。
    3.  その状態で「今すぐバックアップ」を実行します。
* **（代替テスト）:**
    1.  Dropbox App Consoleの「Settings」タブにある「Generated access token」セクションで、「Revoke」ボタンを押し、手動で `access_token` を失効させます。（※これが `refresh_token` に影響しないか確認が必要です）
    2.  または、デバッグ機能として `flutter_secure_storage` から `access_token` だけを削除し、`refresh_token` を残した状態でAPIを呼び出します。
* **期待する動作:**
    * ユーザーにはエラーが表示されません。
    * 内部的に `_refreshToken()` が実行されます。
    * バックアップが（一瞬遅延するかもしれないが）正常に完了します。
* **確認する動作:** `flutter_secure_storage` 内の `access_token` が新しい値に更新されていることを確認します。

### 変更履歴をこの下部に追記