# Zzzone 睡眠記録プログラム仕様書

## 1. 概要

このドキュメントは、Zzzoneアプリケーションにおける睡眠記録機能の仕様を定義する。
本機能は、ユーザーの日々の睡眠を記録・評価し、健康的な睡眠習慣の形成をサポートすることを目的とする。
一日の区切りは午前4時に設定されており、それ以前の就寝は前日の記録として扱われる。

## 2. データモデル

睡眠記録は以下のデータ項目で構成される。これは `lib/models/sleep_record.dart` の `SleepRecord` クラスに基づいている。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | Integer? | データベース上のユニークID（自動採番） |
| `sleepTime` | DateTime | 就寝時刻 |
| `wakeUpTime` | DateTime | 起床時刻 |
| `duration` | Duration | 睡眠時間（`wakeUpTime` - `sleepTime` の計算結果） |
| `score` | Integer | ユーザーによる10段階の睡眠評価 (1-10) |
| `performance` | Integer | 日中の体感パフォーマンス (1:悪い, 2:普通, 3:良い) |
| `hadDaytimeDrowsiness` | Boolean | 昼間に眠気があったかどうか |
| `hasAchievedGoal` | Boolean | 設定した目標入眠時刻を達成したか |
| `didNotOversleep` | Boolean | 二度寝をしなかったかどうか |
| `memo` | String? | 夢の内容や感想などを記録する自由記述欄 |

## 3. 記録方法

睡眠の記録には「自動記録」と「手動記録」の2つの方法がある。

### 3.1. 自動記録

1.  **計測開始**: ホーム画面の「睡眠を開始」ボタンをタップすると、現在の時刻 (`DateTime.now()`) が `sleepTime` として記録され、計測が開始される。
2.  **状態保存**: 計測中の `sleepTime` は `SharedPreferences` に保存されるため、アプリを終了したり、デバイスを再起動したりしても計測は継続される（Web版も同様）。
3.  **計測終了**: ホーム画面の「起床する」ボタンをタップすると、現在の時刻が `wakeUpTime` として記録され、計測が終了する。
4.  **評価入力**: 計測終了後、「睡眠の評価」画面 (`post_sleep_input_screen.dart`) に遷移し、ユーザーは以下の評価項目を入力する。
    *   睡眠スコア (1-10)
    *   日中の体感パフォーマンス
    *   二度寝の有無
    *   メモ
5.  **保存**: 「記録を保存」ボタンをタップすると、目標達成の判定が行われた後、すべてのデータがローカルデータベースに保存される。

### 3.2. 手動記録

1.  **画面遷移**: 履歴画面などから「手動で記録を追加」画面 (`manual_sleep_entry_screen.dart`) に遷移する。
2.  **入力項目**:
    *   **日付**: 記録対象の日付を選択する。過去の日付も選択可能。
    *   **睡眠時間**: 時間と分をプルダウンで選択する。
    *   **評価項目**: 自動記録後と同様の評価項目（スコア、パフォーマンス、二度寝、メモ）を入力する。
3.  **保存**: 「この内容で保存」ボタンをタップするとデータが保存される。
4.  **重複チェック**: 保存時、選択した日付に既に記録が存在するかをチェックし、存在する場合はエラーメッセージを表示して保存を中断する。

## 4. 記録の編集と削除

1.  **画面遷移**: 履歴画面で特定の記録を選択すると、「記録の編集」画面 (`post_sleep_input_screen.dart` が編集モードで開く) に遷移する。
2.  **編集**: 評価項目（スコア、パフォーマンス、二度寝、メモ）を編集できる。就寝・起床時刻は編集不可。
3.  **保存**: 編集内容を保存すると、目標達成 (`hasAchievedGoal`) が再計算され、データが更新される。
4.  **削除**: 編集画面の削除ボタンをタップし、確認ダイアログで承認すると、該当の睡眠記録がデータベースから削除される。

## 5. 機能詳細

### 5.1. 目標達成の判定 (`hasAchievedGoal`)

-   記録の保存時（自動・編集）に、ユーザーが設定した目標入眠時刻（時・分）に基づいて判定される。
-   判定ロジック: `就寝時刻 (sleepTime)` が `(目標入眠時刻 - 90分)` から `(目標入眠時刻 + 30分)` の範囲内にある場合に `true` となる。
-   日の区切り（午前4時）を考慮し、目標時刻が0時〜3時の場合は日付をまたいで判定される。

### 5.2. 昼間の眠気の記録 (`hadDaytimeDrowsiness`)

-   ホーム画面に、その日の睡眠記録が存在し、かつ `hadDaytimeDrowsiness` が `false` の場合にのみ「昼間の眠気を記録」ボタンが表示される。
-   ボタンをタップすると、該当記録の `hadDaytimeDrowsiness` が `true` に更新され、ボタンは非表示（または非活性）になる。

### 5.3. Sleep Coin の付与

-   **新規**の自動記録を保存した際に、睡眠時間（分）と同額の `Sleep Coin` が加算される。
-   コインの合計値は `SharedPreferences` に `sleep_coins` というキーで保存される。
-   手動記録や記録の編集ではコインは付与されない。

### 5.4. ランキング連携

-   **手動記録**を保存する際、ユーザーがランキング参加を有効にしている場合、`SupabaseRankingService` を介して以下の情報がサーバーに送信される。
    *   `userId`
    *   `sleepDuration` (合計睡眠時間（分）)
    *   `date` (記録の論理日付 `yyyy-MM-dd`)
-   現在の実装では、自動記録保存後のランキング連携は行われていない。

## 6. データ永続化

-   睡眠記録は、`database_helper.dart` を介してデバイスのローカルデータベースに保存される。
-   モバイルプラットフォーム (Android/iOS) では `sqflite` を使用する。
-   Webプラットフォームでは `drift` を使用する。
-   テーブル名: `sleep_records`
