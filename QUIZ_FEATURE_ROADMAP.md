# Zzzone クイズ機能 実装ロードマップ

## 1. 概要

ユーザーの再エンゲージメントを目的として、AIが毎日出題する睡眠に関するクイズ機能を実装する。

## 2. 実装タスク

### フェーズ 1: UIの構築

-   [x] **ホーム画面の改修:**
    -   `lib/screens/home_screen.dart` に「Zzzoneクイズ」ボタンを追加する。
    -   ボタンタップ時にクイズ画面に遷移するナビゲーションを実装する。
-   [x] **クイズ画面の作成:**
    -   `lib/screens/quiz_screen.dart` を新規作成する。
    -   以下のUI要素を配置する:
        -   クイズ問題表示用の `Text` ウィジェット
        -   回答入力用の `TextField`
        -   回答提出用の `ElevatedButton`
        -   結果（正解/不正解）と解説表示用の `Card` または `Container`
    -   初期状態のレイアウトを構築する。

### フェーズ 2: AI連携サービスの開発

-   [x] **Gemini API連携設定:**
    -   `pubspec.yaml` に `google_generative_ai` パッケージを追加する。
    -   APIキーを安全に管理する方法を検討・実装する（`flutter_dotenv`など）。
-   [x] **クイズサービス (`QuizService`) の作成:**
    -   `lib/services/quiz_service.dart` を新規作成する。
    -   **`getDailyQuiz()` メソッド:**
        -   Gemini APIを呼び出し、睡眠に関するクイズを1問生成させる。
        -   日付をプロンプトに含めることで、毎日異なる問題が生成されるようにする。
        -   生成された問題を返す。
    -   **`submitAnswer(String question, String answer)` メソッド:**
        -   Gemini APIを呼び出し、問題とユーザーの回答を送信する。
        -   AIに正解/不正解の判定と、その理由/解説を生成させる。
        -   判定結果と解説文をパースして返すためのモデルクラス (`QuizResult`) を作成する。

### フェーズ 3: UIとロジックの統合

-   [x] **クイズ画面のロジック実装:**
    -   画面初期化時に `QuizService.getDailyQuiz()` を呼び出し、問題を表示する。
    -   ローディング中を示すインジケーターを表示する。
    -   「回答を提出」ボタンが押されたら、 `QuizService.submitAnswer()` を呼び出す。
    -   APIからのレスポンスを受け取り、結果（正解/不正解）と解説を画面に表示する。
    -   回答後は入力フィールドと提出ボタンを非活性化するなどの状態管理を行う。

### フェーズ 4: テスト

-   [x] **Widgetテスト:**
    -   ホーム画面にボタンが追加されたことを確認するテストを作成する。
    -   クイズ画面の初期レイアウトが正しく表示されることを確認するテストを作成する。
-   [c] **Unitテスト:**
    -   `QuizService` のテストを作成する。Gemini APIの呼び出しはモック化する。（外部ライブラリのテスト上の制約によりキャンセル）
-   [x] **手動テスト/統合テスト:**
    -   一連のフロー（ホーム画面 → クイズ画面 → 問題取得 → 回答 → 結果表示）が正常に動作することを確認する。

### フェーズ 5: その他

-   [x] **エラーハンドリング:** API通信失敗時や、予期せぬレスポンスが返ってきた場合のエラー表示を実装する。
-   [x] **状態管理:** クイズ画面の状態（問題取得中、回答待ち、結果表示済みなど）を管理するロジックを堅牢にする（`setState`を利用）。

---

## 変更履歴

- **v1.0.0 (2025/12/06):**
  - **初期実装:**
    -   ホーム画面に「Zzzoneクイズ」ボタンを設置。
    -   クイズ画面 (`quiz_screen.dart`) を作成。
    -   Gemini APIと連携し、クイズの取得と回答の判定を行う `QuizService` を実装。
- **v1.1.0 (2025/12/06):**
  - **UI/UX改善:**
    -   クイズ画面表示時に自動で問題を取得するのではなく、「クイズを出題」ボタンをタップしたタイミングで取得するように変更。
    -   結果表示カードの背景色を黒に変更し、ダークテーマでの視認性を向上。
    -   AIの解説文に含まれるMarkdown記法（`*`など）が正しく太字などで表示されるよう、`flutter_markdown_plus`パッケージを導入。
    -   ホーム画面の「Zzzoneクイズ」ボタンを天気予報ウィジェットの上に再配置。
    -   特定の条件下で「昼間の眠気を記録」ボタンが非表示になるレイアウトの問題を修正。
- **v1.2.0 (2025/12/06):**
  - **機能改善:**
    -   一度取得したクイズ、ユーザーの回答、AIの解説を `SharedPreferences` にキャッシュし、同日中は何度画面を開いても状態が復元されるように変更（API呼び出しを1日1回に制限）。
- **v1.3.0 (2025/12/06):**
  - **リファクタリングとテスト:**
    -   `QuizService` のユニットテストを試行。外部ライブラリ (`google_generative_ai`) の`final`クラスの制約により、テスト容易性を向上させるため `IGenerativeModel` インターフェースを導入し、`QuizService`をリファクタリング。
    -   UIのナビゲーションに関するWidgetテストを追加し、正常に動作することを確認。