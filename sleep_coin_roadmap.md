# Sleep Coin 機能開発ロードマップ

## 1. 概要
本ドキュメントは、「Zzzone」アプリに新たに導入する「Sleep Coin（スリープコイン）」機能の開発計画を定義するものです。Sleep Coinは、ユーザーの睡眠記録へのエンゲージメントを高め、将来的にはアプリ内コンテンツ（例：ガチャ機能）との交換を可能にすることを目的とした仮想通貨です。

初期フェーズでは、ユーザーには非表示の内部データとして実装し、機能の基盤を構築します。

## 2. 機能要件
- **コインの名称:** Sleep Coin
- **獲得条件:** アプリの計測機能（タイマー）を使用して記録された睡眠が完了したときのみ。
  - **対象外:** 手動での睡眠記録追加はコイン獲得の対象外とする。
- **獲得レート:** 睡眠時間 **1分** につき **1コイン** を付与する。
  - 例：7時間30分の睡眠 → 450分 → 450コイン
- **データの永続化:** 獲得したコインはユーザーのデバイス内に永続的に保存される。
- **可視性:** ver1の実装では、ユーザーはコインの保有数を確認することはできない。UI上の変更は行わない。

## 3. データ設計
### 3.1. 保存先
ユーザーごとの累計コイン数は、`shared_preferences` を使用してデバイスのローカルストレージに保存します。これは、既存の設定（目標入眠時刻、ユーザー名など）の保存方法と一貫性を保つためです。

### 3.2. データ構造
- **キー:** `sleep_coins`
- **データ型:** `int` (整数)
- **初期値:** 0

## 4. 実装計画
Sleep Coinの獲得ロジックは、睡眠計測が完了し、ユーザーがその記録を保存するタイミングに組み込みます。

### 4.1. 対象ファイル
コイン獲得処理の追加は、以下のファイルで行います。
- `lib/screens/post_sleep_input_screen.dart`

### 4.2. 実装詳細
`post_sleep_input_screen.dart`内の、睡眠記録をデータベースに保存する関数（例：`_saveSleepRecord`のような名前の関数）に、以下の処理を追加します。

1.  **睡眠時間（分）の取得:**
    - 保存される睡眠記録から、睡眠時間の合計（分）を取得します。この値がそのまま獲得コイン数となります。

2.  **現在のコイン数を読み込み:**
    - `shared_preferences`からキー`sleep_coins`を使い、現在の累計コイン数を非同期で読み込みます。値が存在しない場合のデフォルト値は`0`とします。
    ```dart
    final prefs = await SharedPreferences.getInstance();
    final currentCoins = prefs.getInt('sleep_coins') ?? 0;
    ```

3.  **コインの加算と保存:**
    - 読み込んだ累計コイン数に、今回獲得したコイン数を加算します。
    - 計算後の新しい累計コイン数を、再度`shared_preferences`に保存します。
    ```dart
    final newCoins = currentCoins + newEarnedCoins; // newEarnedCoinsは睡眠時間(分)
    await prefs.setInt('sleep_coins', newCoins);
    ```

この実装により、計測完了時のみコインが加算され、データが永続化されます。

## 5. 将来の展望
本機能は、以下のステップを経て拡張されることを想定しています。

### Phase 1: 基盤実装 (今回)
- ユーザーから見えない形で、Sleep Coinの獲得と保存ロジックを実装する。

### Phase 2: UIへの反映
- ユーザーが自身のSleep Coin保有数を確認できるUIを実装する。
  - 例：ホーム画面や設定画面への残高表示。

### Phase 3: コイン消費機能の実装
- Sleep Coinを使用して特定のアクションを行える「ガチャ機能」などを実装する。
- ガチャを引くなどのアクションに応じて、累計コイン数が減少するロジックを追加する。

### Phase 4: コンテンツの拡充
- ガチャから排出されるアイテム（例：特別なアバター、テーマカラー、BGMなど）を拡充し、ユーザーの継続利用を促進する。

## 6. 開発タスクリスト
- [ ] `post_sleep_input_screen.dart`の特定: 睡眠記録の保存処理を行っている箇所を特定する。
- [ ] コイン加算ロジックの実装: 特定した箇所に、`shared_preferences`を使用したコインの読み込み、加算、保存処理を実装する。
- [ ] 動作確認: 睡眠計測を完了させ、`shared_preferences`にコインが正しく加算されていることを（開発者レベルで）確認する。手動入力では加算されないことも併せて確認する。
