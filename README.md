# Zzzone - 睡眠管理アプリ

## 概要
Zzzoneは、日々の睡眠を記録・可視化し、さらに全国のユーザーと睡眠時間を競い合うことで、健康的で楽しい睡眠習慣をサポートするモバイルアプリケーションです。新たに、偉人たちの「名言」を集めるガチャ機能が追加され、コレクションとカスタマイズの楽しみが広がりました。

## 主な機能

### 1. 睡眠記録と評価
- **自動計測・手動記録:** 日々の睡眠を手軽に、または詳細に記録できます。
- **睡眠評価:** 睡眠スコア、体感パフォーマンス、二度寝の有無など、多角的に睡眠を評価します。
- **目標達成:** 設定した目標入眠時刻を守ることで、ゲーム感覚で睡眠習慣の改善を目指せます。

### 2. ガチャ機能と名言コレクション
- **名言ガチャ:** 睡眠時間に応じて獲得できる「スリープコイン」を使い、古今東西の偉人たちの「名言」を獲得できるガチャを引くことができます。
- **レアリティ:** 名言には「コモン」「レア」「激レア」などのレアリティが設定されており、確率に基づいた抽選が行われます。
- **10連ガチャ:** 1回分お得に、一度に10個の名言を獲得できる10連ガチャも搭載しています。
- **ガチャ履歴:** これまで引いたガチャの結果をすべて時系列で確認できます。
- **演出:** ガチャを引く際には、獲得した名言の最高レアリティに応じたアニメーション演出が再生されます。
- **ガチャポイント:** ガチャを1回引くごとに1ポイントが貯まります。将来的に、ポイントを使って特別なアイテムと交換できるようになる予定です。

### 3. ホーム画面のカスタマイズ
- **お気に入り名言:** 「名言一覧」画面から、獲得した名言の中から好きなものを「お気に入り」に設定できます。設定した名言はホーム画面に常に表示されます。
- **ランダムモード:** 「お気に入り」を設定せず、「ランダムモード」をONにすると、獲得した名言の中から日替わりで異なる名言がホーム画面に表示されます。

### 4. 履歴と分析
- **睡眠履歴:** グラフやカレンダー形式で、過去の睡眠記録を直感的に振り返ることができます。
- **AIによる睡眠分析:** 5件以上の睡眠記録を元に、AI(Google Gemini)があなたの睡眠傾向を分析し、「総評」「良い点」「改善点」を提案します。

### 5. ショップ
- **タブ切り替え:** ショップは「背景色」と「ガチャ」の2つのタブで構成されています。
- **背景色の購入:** スリープコインを使い、ランキング画面で利用できる背景色を購入できます。

### 6. プロフィールと睡眠時間ランキング
- **プロフィール画面:** ユーザー名、ランキングへの参加設定、ランキングで表示される背景色などを一元管理できます。
- **全国ランキング:** 全ユーザーのその日の睡眠時間を集計し、ランキング形式で表示します。

---

## アーキテクチャ (v3)

### クライアントサイド
- **フレームワーク:** Flutter (Dart)
- **ローカルデータベース:** SQLite (`sqflite`) / Web向けインメモリ + `shared_preferences`
  - **保存データ:** 睡眠記録、**獲得した名言リスト**、**ガチャの履歴**
- **状態管理/設定保存:** `shared_preferences`

### バックエンド
- **ランキング・通貨管理:** Supabase (PostgreSQL)
- **AI分析機能:** Google Gemini API

---

## 開発環境のセットアップ

### 1. クライアントのセットアップ
(変更なし)

### 2. バックエンドのセットアップ
1.  **Supabaseプロジェクトを作成**
2.  **テーブルとカラムのスキーマを設定:**
    - SupabaseプロジェクトのSQL Editorから、以下のSQLを実行します。
    - **`users`テーブル:**
      ```sql
      -- 基本スキーマ (初回セットアップ時)
      CREATE TABLE public.users (
        id UUID NOT NULL PRIMARY KEY,
        username CHARACTER VARYING(20) NOT NULL UNIQUE,
        background_preference TEXT DEFAULT 'default',
        sleep_coins INTEGER NOT NULL DEFAULT 0,
        favorite_quote_id TEXT
      );

      -- 既存テーブルへの追加
      ALTER TABLE public.users ADD COLUMN sleep_coins INTEGER NOT NULL DEFAULT 0;
      ALTER TABLE public.users ADD COLUMN favorite_quote_id TEXT;
      ALTER TABLE public.users ADD COLUMN gacha_pull_count INTEGER NOT NULL DEFAULT 0;
      ALTER TABLE public.users ADD COLUMN gacha_points INTEGER NOT NULL DEFAULT 0;
      ```
    - **`sleep_records`テーブル:**
      ```sql
      -- 基本スキーマ (初回セットアップ時)
      CREATE TABLE public.sleep_records (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
        date DATE NOT NULL,
        sleep_duration INTEGER NOT NULL,
        created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        data_id UUID,
        UNIQUE (user_id, date)
      );
      ```
    - **`user_unlocked_backgrounds`テーブル:**
      ```sql
      CREATE TABLE public.user_unlocked_backgrounds (
        user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
        background_id TEXT NOT NULL,
        purchased_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        PRIMARY KEY (user_id, background_id)
      );
      ```
    - **`user_unlocked_quotes`テーブル:**
      ```sql
      CREATE TABLE public.user_unlocked_quotes (
        user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
        quote_id TEXT NOT NULL,
        unlocked_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        UNIQUE (user_id, quote_id)
      );
      ```
3.  **RPC関数の設定:**
    - 以下のSQLを実行し、安全なサーバーサイド関数を作成します。
    - **`purchase_background`関数:**
      ```sql
      -- (内容はgacha_feature_roadmap.mdを参照)
      ```
    - **`deduct_coins_for_gacha`関数:**
      ```sql
      CREATE OR REPLACE FUNCTION deduct_coins_for_gacha(p_user_id UUID, p_cost INT, p_pull_count INT)
      RETURNS void AS $$
      DECLARE
        current_coins INT;
      BEGIN
        -- 現在のコイン残高を取得
        SELECT sleep_coins INTO current_coins FROM public.users WHERE id = p_user_id;

        -- コインが足りているかチェック
        IF current_coins < p_cost THEN
          RAISE EXCEPTION 'insufficient_funds';
        END IF;

        -- コインを消費し、ガチャ回数とポイントを更新
        UPDATE public.users
        SET
          sleep_coins = current_coins - p_cost,
          gacha_pull_count = gacha_pull_count + p_pull_count,
          gacha_points = gacha_points + p_pull_count -- 1プル=1ポイントの場合
        WHERE id = p_user_id;
      END;
      $$ LANGUAGE plpgsql SECURITY DEFINER;
      ```

---

## 開発者情報
- **アプリ名:** Zzzone（ズォーン）
- **制作者名:** kou09427,syuu55
- **共同編集:** Gemini-1.5-pro
