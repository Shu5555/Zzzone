# Zzzone - 睡眠管理アプリ

## 概要
Zzzoneは、日々の睡眠を記録・可視化し、さらに全国のユーザーと睡眠時間を競い合うことで、健康的で楽しい睡眠習慣をサポートするモバイルアプリケーションです。記録を忘れた日のために、後から手動で記録を追加する機能も備えています。夜更かしをしても前日分に記録が入るように、一日の区切りを午前4時に設定しています。

## 主な機能

### 1. 睡眠記録と評価
- **自動計測:** 入眠・起床時刻を記録し、睡眠時間を自動計算します。
- **手動での記録追加:** 過去の日付を選択し、睡眠時間を手動で入力できます。自動計測時と同様に、睡眠の質（スコア、パフォーマンス等）も記録可能です。
- **詳細な睡眠評価:** 
  - 10段階の睡眠スコア
  - 日中の体感パフォーマンス（良い/普通/悪い）
  - 昼間の眠気の有無（後から記録可能）
  - 二度寝の有無
  - 自由なメモ機能
- **目標入眠時刻設定:** 設定した時刻の90分前から30分後までに入眠すると「目標達成」となります。

### 2. 履歴と分析
- **履歴表示:** 週表示・月表示での記録の確認、グラフでの睡眠時間推移の可視化ができます。
- **統計表示:** 目標達成率や、条件別の平均スコアなどを分析・表示します。
- **AIによる睡眠分析:** 5件以上の睡眠記録があると、AI(Google Gemini)があなたの睡眠傾向を分析し、「総評」「良い点」「改善点」を提案します。この分析は、睡眠データが更新された場合にのみ自動で実行され、結果はキャッシュされるため、効率的に最新の分析を確認できます。
- **カレンダー履歴:** 月ごとのカレンダー形式で、各日の睡眠時間を直感的に確認できます。

### 3. 睡眠時間ランキング
- **全国ランキング:** 全ユーザーのその日の睡眠時間を集計し、ランキング形式で表示します。ユーザー名は20文字までの制限があり、他のユーザーと重複しないものを設定する必要があります。
- **UIの装飾:** 上位3位のユーザーは、ランキング上で特別なカラーリングで強調表示されます。
- **オプトイン方式:** プライバシーに配慮し、ユーザーが自らの意思でランキングに参加するかを選択できます。
- **最新記録の反映:** ランキングには、各ユーザーがその日に記録した最新の睡眠記録のみが反映されます。

### 4. 設定とデータ管理
- **目標入眠時刻:** 睡眠目標達成の基準となる時刻を自由に設定できます。
- **ランキング設定:** ランキングへの参加、および表示されるユーザー名の変更が可能です。
- **ランキングデータの削除:** サーバーに保存されている、自身のランキングに関連するすべてのデータ（ユーザー情報と睡眠記録）を削除します。
- **すべての睡眠記録を削除:** アプリ内に保存されているすべての睡眠記録を削除します。ランキングに参加している場合は、サーバー上の記録も同時に削除されます。

### 5. Web版での計測持続
- Flutter for Webで実行中、ブラウザのタブを閉じたり再起動したりしても、進行中の睡眠計測が失われることはありません。再訪問すると、計測が継続された状態でアプリが復元します。

### 6. ホーム画面
- 日替わりでカントの名言や、直近の睡眠スコアに応じたアドバイスを表示します。

## アーキテクチャ

### クライアントサイド
- **フレームワーク:** Flutter (Dart)
- **ローカルデータベース:** SQLite (`sqflite`)
- **状態管理/設定保存:** `shared_preferences`
- **HTTP通信:** `http`
- **グラフ描画:** `fl_chart`
- **カレンダーUI:** `table_calendar`

### バックエンド
- **ランキング機能:** Netlify Functions / Supabase (PostgreSQL)
- **AI分析機能:** Google Gemini API

ランキング機能はNetlifyとSupabaseで構築されたサーバーレスバックエンドを利用しています。AIによる睡眠分析は、クライアントから直接Google Gemini APIを呼び出す構成になっています。

## 開発環境のセットアップ

### 1. クライアントのセットアップ
1.  **Flutter SDKのインストール:** [Flutter公式サイト](https://flutter.dev/docs/get-started/install)の指示に従ってFlutter SDKをインストールし、環境変数を設定してください。
2.  **プロジェクトのクローン:** このプロジェクトのソースコードをダウンロードまたはクローンします。
3.  **依存関係の取得:** プロジェクトのルートディレクトリで以下のコマンドを実行します。
    ```bash
    flutter pub get
    ```
4.  **アプリの実行:** Androidエミュレータまたは実機を接続し、以下のコマンドでアプリを起動します。
    ```bash
    flutter run
    ```

### 2. バックエンドのセットアップ (ランキング機能)
ランキング機能などを完全に動作させるには、バックエンドの設定が必要です。

1.  **Supabaseのセットアップ:**
    - Supabaseで新規プロジェクトを作成します。
    - `users`と`sleep_records`テーブルを作成します（詳細は`ranking_development_plan.md`を参照）。
    - 作成したテーブルの**Row-Level Security (RLS)は無効に設定**してください。

2.  **データベースの制約設定（必須）:**
    - SupabaseプロジェクトのSQL Editorから、以下のSQLを**両方とも**実行し、テーブルに制約を追加します。これにより、データの整合性が保たれ、アプリケーションが正しく動作します。
    - **`sleep_records`テーブルへのUNIQUE制約追加（データ重複防止）:**
      ```sql
      ALTER TABLE public.sleep_records
      ADD CONSTRAINT sleep_records_user_id_date_key UNIQUE (user_id, date);
      ```
    - **`users`テーブルへの文字数制限追加:**
      ```sql
      ALTER TABLE public.users
      ALTER COLUMN username TYPE character varying(20);
      ```
    - **`users`テーブルへのUNIQUE制約追加（ユーザー名重複防止）:**
      ```sql
      ALTER TABLE public.users
      ADD CONSTRAINT users_username_key UNIQUE (username);
      ```

    - **`sleep_records`テーブルの外部キー設定変更（ユーザー削除対応）:**
      - `users`テーブルからユーザーが削除された際に、関連する`sleep_records`も自動的に削除されるように設定します。これにより、ユーザーが自身の全データを削除する機能が正しく動作します。
      - 以下のSQLを実行してください。
      ```sql
      -- 既存の外部キー制約を削除し、ON DELETE CASCADEを付けて再作成します。
      -- これにより、usersテーブルの行が削除されると、関連するsleep_recordsテーブルの行も自動的に削除されます。
      ALTER TABLE public.sleep_records
      DROP CONSTRAINT IF EXISTS sleep_records_user_id_fkey;

      ALTER TABLE public.sleep_records
      ADD CONSTRAINT sleep_records_user_id_fkey
      FOREIGN KEY (user_id)
      REFERENCES public.users (id)
      ON DELETE CASCADE;
      ```

3.  **Netlifyのセットアップ:**
    - 本プロジェクトのGitリポジトリをNetlifyに連携してデプロイします。
    - Netlifyの環境変数に、SupabaseプロジェクトのURLと`anon`キーをそれぞれ`SUPABASE_URL`、`SUPABASE_ANON_KEY`として設定します。

## APKファイルのビルド方法
リリース用のAPKファイルをビルドするには、プロジェクトのルートディレクトリで以下のコマンドを実行します。
```bash
flutter build apk --release
```
生成されたAPKファイルは `build/app/outputs/flutter-apk/app-release.apk` にあります。

## 開発者情報
- **アプリ名:** Zzzone（ズォーン）
- **制作者名:** kou09427,syuu55
- **共同編集:** Gemini-2.5-pro
- **アイコン制作:** syuu55
- **対応端末:** Android, Web

---

**謝辞:**
本アプリの開発にご協力いただいた皆様に深く感謝いたします。
