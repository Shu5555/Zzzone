# Zzzone 睡眠記録プログラム新仕様書

## 1. 概要

このドキュメントは、Zzzoneアプリケーションにおける睡眠記録機能の新仕様を定義する。
タイムゾーンは日本標準時JSTを基準にしており、ユーザーは全員日本居住者であるため問題はない。
一日の区切りは午前4時に設定されており、それ以前の就寝は前日の記録として扱われる。
また、新仕様の記録と旧仕様の記録が判断できるようにし、旧仕様の記録は新仕様の記録に自動的に移行されるようにする。
具体的にはタイムゾーンがUTCから日本標準時JSTに、起床時の日本の日付が記録の日付に変わっている。
移行に関する方針は定まっていないので決めること。

## 2. データモデル

睡眠記録は以下のデータ項目で構成される。これは `lib/models/sleep_record.dart` の `SleepRecord` クラスに基づいている。

| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| `dataId` | Integer? | データベース上のユニークID（UUID） |
| `sleepTime` | DateTime | 就寝時刻 |
| `wakeUpTime` | DateTime | 起床時刻 |
| `duration` | Duration | 睡眠時間（`wakeUpTime` - `sleepTime` の計算結果） |
| `score` | Integer | ユーザーによる10段階の睡眠評価 (1-10) |
| `performance` | Integer | 日中の体感パフォーマンス (1:悪い, 2:普通, 3:良い) |
| `hadDaytimeDrowsiness` | Boolean | 昼間に眠気があったかどうか |
| `hasAchievedGoal` | Boolean | 設定した目標入眠時刻を達成したか |
| `didNotOversleep` | Boolean | 二度寝をしなかったかどうか |
| `memo` | String? | 夢の内容や感想などを記録する自由記述欄 |

## 3. 記録方法

睡眠の記録には「自動記録」と「手動記録」の2つの方法がある。
UIを手動記録の画面に統一する。
細かい流れは以下に記述する。

### 3.1. 自動記録

1.  **計測開始**: ホーム画面の「睡眠を開始」ボタンをタップすると、現在の日本時間が就寝時刻として記録され、計測が開始される。
2.  **状態保存**: 就寝開始時刻は保存され、アプリを終了したり、デバイスを再起動したりしても計測は継続される（Web版も同様）。
3.  **計測終了**: ホーム画面の「起床する」ボタンをタップすると計測が終了する。なお、現在の日本時間が起床時刻として記録され、このボタンを押したときの日本の日付がこの睡眠の記録の日付として記録される。
4.  **入力項目**: 計測終了後、「睡眠の評価」画面に遷移し、ユーザーは評価項目を入力する。
5.  **保存**: 「保存」ボタンをタップすると、目標達成の判定が行われた後データが保存される。

### 3.2. 手動記録

1.  **画面遷移**: 履歴画面などから「睡眠の評価」画面に遷移する。
2.  **入力項目**:
3.  **保存**: 「保存」ボタンをタップするとデータが保存される。
4.  **重複チェック**: 保存時、選択した日付に既に記録が存在するかをチェックし、存在する場合はエラーメッセージを表示して保存を中断するが、「記録の評価」画面からホーム画面に遷移しない。

### 3.3. 「睡眠の評価」画面
- 
    *   日付: 記録対象の日付を選択する。自動記録の場合は変更不可。
    *   睡眠時間: 時間と分をプルダウンで選択する。自動記録の場合は変更不可。
    *   評価項目: 自動記録後と同様の評価項目（スコア、パフォーマンス、二度寝、メモ）を入力する。
    *   睡眠スコア (1-10)
    *   日中の体感パフォーマンス
    *   昼間に眠気があったかどうか: チェックボックス。初期値false。起床した日の記録であればホーム画面のボタンからも評価可能。
    *   二度寝の有無: チェックボックス。初期値false。
    *   メモ

## 4. 記録の編集と削除
-   UIは記録の評価と同じものを使いまわすが、削除ボタンは編集時のみ表示される。
    1.  **画面遷移**: 履歴画面で特定の記録を選択すると、「記録の評価」画面に遷移する。
    2.  **編集**: 特定の記録の評価項目や就寝・起床時刻などを編集できる。ただし、日付は編集不可。
    3.  **保存**: 編集内容を保存すると、目標達成が再計算され、データが更新される。
    4.  **削除**: 編集画面の削除ボタンをタップし、確認ダイアログで承認すると、該当の睡眠記録が削除される。

## 5. データの保存
-   データはすべてローカルに保存する。
    この時、ほかの記録と混在したり、壊れたりしないように厳格に管理できるように整える。

##　6. ランキング機能
-  　どんな方法でも関わらず、データを保存する際、ユーザーがランキング参加を有効にしている場合、以下の情報が次の条件に従ってサーバーに送信される。
    なお、`sleep_records`のテーブルに同じuserIdがいる場合かつ送信するデータの日付が日本の本日日付である場合はそのデータに上書きするようにする。`sleep_records`テーブルに同じuserIdがいない場合は新規保存する。送信するデータの日付が日本の本日日付でない場合は送信しない。
    *   `userId`
    *   `dataId`
    *   `sleepDuration` (合計睡眠時間（分）)
    *   `date` (記録の起床したときの日本の日付 `yyyy-MM-dd`)

## 7.　プロフィール機能の追加
-   現在のランキング設定をプロフィール機能に移行する。
    そこでは以下の設定が可能である。
    *   ユーザー名
    *   ランキング参加の有無
    * 　ランキングデータの削除
    *   Sleep_Coinの所持枚数の表示
    *   userIdの表示
-   なお、データを設定を変更した際だけ保存ボタンが押せるようになり、変更内容がサーバーに送信される。